<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MULTAs v2.1 - 医学実習レポート自動生成システム（AI分類対応）</title>
    <style>
        /* === ベーススタイル === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            background: linear-gradient(135deg, #81c784 0%, #b39ddb 100%);
            height: 100vh;
            color: #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }

        /* === ヘッダー === */
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            text-align: center;
            color: white;
            flex-shrink: 0;
            position: relative;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* === 日付選択 === */
        .day-selector {
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .day-display {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            background: #7e57c2;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(126, 87, 194, 0.3);
        }

        .day-display:hover {
            background: #673ab7;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(126, 87, 194, 0.4);
        }

        .day-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            overflow: hidden;
            display: none;
            white-space: nowrap;
        }

        .day-dropdown.active {
            display: flex;
            flex-direction: row;
            gap: 2px;
            padding: 8px;
        }

        .day-option {
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.85rem;
            color: white;
            border-radius: 4px;
        }

        .day-option:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .day-option.selected {
            background: #7e57c2;
            color: white;
        }

        /* === モニター切り替えタブ === */
        .monitor-tabs {
            display: flex;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            justify-content: center;
        }

        .monitor-tab {
            padding: 10px 24px;
            border: 2px solid #4a9eff;
            background: white;
            color: #4a9eff;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 25px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 140px;
            text-align: center;
        }

        .monitor-tab:hover {
            background: #e8f2ff;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(74, 158, 255, 0.2);
        }

        .monitor-tab.active {
            background: #66bb6a;
            color: white;
            border-color: #66bb6a;
            box-shadow: 0 4px 12px rgba(102, 187, 106, 0.3);
        }

        /* === メインコンテンツエリア === */
        .main-content {
            flex: 1;
            padding: 0;
            background: white;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        /* === 統計固定エリア === */
        .monitor-stats {
            background: white;
            padding: 12px 20px 8px;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }

        /* === スクロール可能コンテンツ === */
        .monitor-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
            min-height: 0;
        }

        /* === モニター表示 === */
        .monitor {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .monitor.active {
            display: flex;
        }

        .monitor h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 6px;
            margin: 0 0 15px 0;
        }

        /* === 統計カード === */
        .stats-grid {
            display: flex;
            gap: 6px;
            margin-bottom: 0;
            align-items: center;
        }

        .exp-bar-container {
            flex: 1;
            height: 30px;
            background: rgba(0,0,0,0.1);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin-left: 10px;
        }

        .exp-bar {
            height: 100%;
            background: linear-gradient(90deg, #b39ddb 0%, #9575cd 100%);
            border-radius: 15px;
            transition: width 0.5s ease;
            box-shadow: 0 2px 4px rgba(179, 157, 219, 0.3);
        }

        .exp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-weight: 600;
            font-size: 0.8rem;
            text-shadow: 0 0 2px rgba(255,255,255,0.8);
        }

        .stat-card {
            background: rgba(179, 157, 219, 0.08);
            border-radius: 5px;
            padding: 4px 8px;
            text-align: center;
            border: 1px solid rgba(179, 157, 219, 0.12);
            flex: 1;
            min-width: 60px;
            max-width: 80px;
        }

        .stat-number {
            font-size: 0.85rem;
            font-weight: bold;
            color: #7e57c2;
            margin-bottom: 1px;
        }

        .stat-label {
            color: #999;
            font-size: 0.65rem;
            line-height: 1.1;
        }

        /* === 記録アイテム === */
        .record-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .record-item:hover {
            transform: translateX(3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left-color: #5a67d8;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .record-timestamp {
            color: #666;
            font-size: 0.8rem;
        }

        .record-actions {
            display: flex;
            gap: 6px;
        }

        .record-btn {
            padding: 6px 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .record-btn:hover {
            background: #f5f5f5;
            border-color: #999;
            transform: translateY(-1px);
        }

        .edit-btn {
            color: #555;
        }

        .delete-btn {
            color: #666;
        }

        .save-btn {
            background: #4a9eff;
            color: white;
            border-color: #4a9eff;
        }

        .save-btn:hover {
            background: #357abd;
            border-color: #357abd;
        }

        .cancel-btn {
            color: #888;
        }

        .record-text {
            margin-bottom: 14px;
            line-height: 1.8;
            font-size: 1.2rem;
            color: #333;
            font-weight: 500;
            word-wrap: break-word;
            letter-spacing: 0.02em;
        }

        .record-category {
            display: inline-block;
            padding: 5px 10px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .record-ai-indicator {
            display: inline-block;
            margin-left: 8px;
            padding: 3px 7px;
            background: #4caf50;
            color: white;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        /* === カテゴリ別表示 === */
        .category-section {
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            background: #f8f9fa;
        }

        .category-header {
            padding: 12px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .category-content {
            padding: 15px;
        }

        .category-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .category-item .category-text {
            font-size: 1.15rem;
            line-height: 1.8;
            color: #333;
            font-weight: 500;
            word-wrap: break-word;
            letter-spacing: 0.02em;
        }

        /* === レポート表示 === */
        .report-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .report-section {
            margin-bottom: 20px;
        }

        .report-section h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 4px;
        }

        /* === 統計表示 === */
        .stats-display {
            display: block;
        }

        .stats-display.hidden {
            display: none;
        }

        .report-actions {
            display: flex;
            gap: 8px;
            margin: 0;
        }

        .btn-secondary {
            flex: 1;
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .btn-advance,
        .btn-previous {
            background: #90EE90;
            color: #2d5a2d;
        }

        .btn-advance:hover,
        .btn-previous:hover {
            background: #7dd87d;
        }


        /* === ボトム入力フォーム === */
        .bottom-input {
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 15px 20px 20px;
            flex-shrink: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        .experience-input {
            flex: 1;
        }

        .input-row label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
        }

        .input-row input,
        .input-row textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .input-row input:focus,
        .input-row textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-row textarea {
            resize: none;
            height: 60px;
            min-height: 60px;
            max-height: 120px;
            padding-right: 60px;
        }

        .submit-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 45px;
            height: 45px;
            background: #b39ddb;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(179, 157, 219, 0.4);
            z-index: 10;
        }

        .submit-btn svg {
            width: 24px;
            height: 24px;
            transform: rotate(-10deg);
        }

        .submit-btn:hover {
            background: #9575cd;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(179, 157, 219, 0.6);
        }

        .submit-btn:active {
            transform: scale(0.95);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* === ステータス表示 === */
        .status-message {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        /* === ローディング === */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === 編集モード === */
        .edit-mode {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

        .edit-textarea {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
        }

        .edit-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .save-btn {
            background: #28a745;
            color: white;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        /* === 空状態表示 === */
        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* === レスポンシブ調整 === */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.8rem;
            }

            .monitor-tab {
                font-size: 0.8rem;
                padding: 10px 6px;
            }

            .monitor h3 {
                font-size: 1rem;
                margin-bottom: 12px;
            }

            .bottom-input {
                padding: 12px 15px 15px;
            }

            .input-row {
                flex-direction: column;
                gap: 5px;
            }


            .stats-grid {
                gap: 4px;
                margin-bottom: 0;
            }

            .stat-card {
                padding: 3px 6px;
                min-width: 55px;
                max-width: 70px;
            }

            .stat-number {
                font-size: 0.75rem;
                color: #7e57c2;
            }

            .stat-label {
                font-size: 0.6rem;
                color: #aaa;
            }

            .report-actions {
                gap: 6px;
            }

            .record-text {
                font-size: 1.1rem;
                line-height: 1.7;
                letter-spacing: 0.01em;
            }

            .category-item .category-text {
                font-size: 1.05rem;
                line-height: 1.7;
                letter-spacing: 0.01em;
            }

            .monitor-stats {
                padding: 8px 15px 6px;
            }

            .monitor-content {
                padding: 12px 15px;
            }

            .monitor h3 {
                font-size: 1rem;
                margin-bottom: 12px;
            }

            .btn-secondary {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
        }

        /* === キーボード操作対応 === */
        .input-row textarea {
            transition: height 0.3s ease;
        }

        .input-row textarea:focus {
            height: 80px;
        }
    </style>
</head>
<body>
    <!-- ヘッダー -->
    <div class="header">
        <h1>MULTAs</h1>
        <p>Medical University Learning and Training Assessment system</p>
        <!-- 日付選択 -->
        <div class="day-selector">
            <div class="day-display" onclick="toggleDayDropdown()">
                <span id="currentDayLabel">1日目</span>
                <span style="font-size: 0.7em;">▼</span>
            </div>
            <div class="day-dropdown" id="dayDropdown">
                <div class="day-option" onclick="selectDay('practice')">練習</div>
                <div class="day-option selected" onclick="selectDay(1)">1日</div>
                <div class="day-option" onclick="selectDay(2)">2日</div>
                <div class="day-option" onclick="selectDay(3)">3日</div>
                <div class="day-option" onclick="selectDay(4)">4日</div>
                <div class="day-option" onclick="selectDay(5)">5日</div>
            </div>
        </div>
    </div>

    <!-- モニター切り替えタブ -->
    <div class="monitor-tabs">
        <button class="monitor-tab active" onclick="switchMonitor('monitor1')">
            LOG
        </button>
        <button class="monitor-tab" onclick="switchMonitor('monitor2')">
            LIST
        </button>
        <button class="monitor-tab" onclick="switchMonitor('monitor3')">
            REPORT
        </button>
    </div>

    <!-- メインコンテンツ -->
    <div class="main-content">
        
        <!-- 統計固定エリア -->
        <div class="monitor-stats">
            <!-- モニター1用統計 -->
            <div id="stats-monitor1" class="stats-display">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="recordCount">0</div>
                        <div class="stat-label">記録回数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="userLevel">1</div>
                        <div class="stat-label">LV</div>
                    </div>
                    <div class="exp-bar-container">
                        <div class="exp-bar" id="expBar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <!-- モニター2用統計 -->
            <div id="stats-monitor2" class="stats-display" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="recordCount2">0</div>
                        <div class="stat-label">記録回数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="userLevel2">1</div>
                        <div class="stat-label">LV</div>
                    </div>
                    <div class="exp-bar-container">
                        <div class="exp-bar" id="expBar2" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <!-- モニター3用統計 -->
            <div id="stats-monitor3" class="stats-display" style="display: none;">
                <div class="report-actions">
                    <button class="btn-secondary" onclick="generateDailyReport()">
                        🤖 レポート生成
                    </button>
                </div>
            </div>
        </div>

        <!-- モニター1: ログ保存 -->
        <div id="monitor1" class="monitor active">
            <div class="monitor-content">
                <div id="recordsList">
                    <div class="empty-state">
                        <div class="icon">📝</div>
                        <p>まだ記録がありません<br>下のフォームから最初の記録を追加してください</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- モニター2: 体験整理 -->
        <div id="monitor2" class="monitor">
            <div class="monitor-content">
                <div id="organizedView">
                    <div class="empty-state">
                        <div class="icon">🤖</div>
                        <p>記録を追加すると<br>AI分析による12時計分類が表示されます</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- モニター3: Dailyレポート -->
        <div id="monitor3" class="monitor">
            <div class="monitor-content">
                <div id="dailyReport">
                    <div class="report-content">
                        <h4>📋 本日の実習レポート</h4>
                        <div class="empty-state">
                            <div class="icon">📊</div>
                            <p>記録を追加してから<br>「レポート生成」ボタンを押すと<br>その日の体験をまとめたレポートが自動生成されます</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ボトム入力フォーム -->
    <div class="bottom-input">
        <div class="input-row">
            <div class="experience-input" style="position: relative;">
                <textarea id="experienceText" placeholder="実習で体験したことを記録… ※患者の個人情報は入力しない"></textarea>
                <button type="button" class="submit-btn" onclick="submitExperience()" title="送信">
                    <span id="submitText">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="white"/>
                        </svg>
                    </span>
                    <span id="submitLoading" style="display: none;">
                        <span class="loading"></span>
                    </span>
                </button>
            </div>
        </div>

        <div id="statusMessage"></div>
    </div>

    <script>
        // === グローバル変数 ===
        let records = [];
        let recordIdCounter = 0;
        let currentMonitor = 'monitor1';
        let currentDay = 1;  // 現在の日付（1-5またはpractice）
        
        // === OpenAI API設定 ===
        const OPENAI_API_KEY = 'YOUR_API_KEY_HERE'; // ここにAPIキーを設定
        // テスト用にプロンプトから入力する場合は、以下のコメントを外してください
        // const OPENAI_API_KEY = prompt('OpenAI APIキーを入力してください:');
        
        // === 医学実習12時計分類システム ===
        const CLOCK_CATEGORIES = {
            0: { name: '分類不能', icon: '❓', vector: {x: 0, y: 0} },
            1: { name: '地域医療', icon: '🏘️', vector: {x: -0.5, y: 0.8} },
            2: { name: '医療倫理', icon: '⚖️', vector: {x: -0.3, y: -0.5} },
            3: { name: '医学知識', icon: '📚', vector: {x: 0.8, y: -0.5} },
            4: { name: '診察・手技', icon: '🩺', vector: {x: 0.9, y: -0.7} },
            5: { name: '患者に対する問題解決能力', icon: '🤝', vector: {x: 0.5, y: -0.9} },
            6: { name: '統合的臨床', icon: '🏥', vector: {x: 0, y: -0.8} },
            7: { name: '多職種連携', icon: '👥', vector: {x: -0.5, y: -0.7} },
            8: { name: 'コミュニケーション', icon: '💬', vector: {x: -0.8, y: -0.3} },
            9: { name: '一般教養', icon: '📖', vector: {x: -0.9, y: 0.3} },
            10: { name: '施設連携', icon: '🏥', vector: {x: -0.7, y: 0.7} },
            11: { name: '保健・福祉', icon: '🏛️', vector: {x: -0.3, y: 0.9} },
            12: { name: '統合的社会', icon: '🌍', vector: {x: 0, y: 0.9} }
        };
        let userLevel = 1;
        let userExp = 0;
        const EXP_PER_RECORD = 20;
        const EXP_TO_LEVEL_UP = 100;

        // === 12時計カテゴリの色定義 ===
        const AI_CATEGORIES = {
            0: { name: '❓ 分類不能', color: '#b2bec3' },
            1: { name: '🏘️ 地域医療', color: '#ff6b6b' },
            2: { name: '⚖️ 医療倫理', color: '#ff9ff3' },
            3: { name: '📚 医学知識', color: '#54a0ff' },
            4: { name: '🩺 診察・手技', color: '#48dbfb' },
            5: { name: '🤝 患者に対する問題解決能力', color: '#1dd1a1' },
            6: { name: '🏥 統合的臨床', color: '#10ac84' },
            7: { name: '👥 多職種連携', color: '#feca57' },
            8: { name: '💬 コミュニケーション', color: '#ff9ff3' },
            9: { name: '📖 一般教養', color: '#dfe6e9' },
            10: { name: '🏥 施設連携', color: '#a29bfe' },
            11: { name: '🏛️ 保健・福祉', color: '#6c5ce7' },
            12: { name: '🌍 統合的社会', color: '#fd79a8' }
        };

        // === 体験記録送信 ===
        async function submitExperience() {
            const experienceText = document.getElementById('experienceText').value.trim();
            
            if (!experienceText) {
                showStatus('体験内容を入力してください。', 'error');
                return;
            }

            // UI状態を処理中に変更
            const submitBtn = document.querySelector('.submit-btn');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');
            
            submitBtn.disabled = true;
            submitText.style.display = 'none';
            submitLoading.style.display = 'inline-block';

            try {
                // AI分類を実行
                showStatus('🤖 AI分析中...', 'info');
                const aiResult = await classifyWithAI(experienceText);
                
                // ローカル処理で即座に表示
                const localRecord = {
                    id: ++recordIdCounter,
                    originalText: experienceText,
                    timestamp: new Date(),
                    day: currentDay, // 現在の日付を記録
                    category: aiResult.category,
                    confidence: aiResult.confidence,
                    aiProcessed: true,
                    aiReason: aiResult.reason,
                    depth: aiResult.depth,
                    vector: aiResult.vector,
                    consistency: aiResult.consistency
                };

                records.unshift(localRecord);
                
                // 経験値を追加
                addExperience(EXP_PER_RECORD);
                
                updateAllViews();
                showStatus('✅ 送信しました！', 'success');

                // バックグラウンドでGAS処理
                try {
                    const response = await fetch(window.location.href, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'processExperience',
                            studentName: studentName,
                            experienceText: experienceText
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            // GAS処理成功時にローカル記録を更新
                            localRecord.category = result.classificationResult.category;
                            localRecord.confidence = result.classificationResult.confidence;
                            localRecord.aiProcessed = result.classificationResult.aiProcessed;
                            updateAllViews();
                            showStatus('🤖 AI分析完了！分類結果を更新しました。', 'success');
                        }
                    }
                } catch (gasError) {
                    console.log('GAS処理はスキップ（ローカル動作）:', gasError);
                }

            } catch (error) {
                // ローカル環境では正常動作なのでエラー表示しない
                console.log('ローカル環境での動作:', error);
            } finally {
                // UI状態を元に戻す
                submitBtn.disabled = false;
                submitText.style.display = 'inline-block';
                submitLoading.style.display = 'none';
                
                // フォームをクリア
                document.getElementById('experienceText').value = '';
            }
        }

        // === モニター切り替え ===
        function switchMonitor(monitorId) {
            // 全モニターを非表示
            document.querySelectorAll('.monitor').forEach(monitor => {
                monitor.classList.remove('active');
            });

            // 全タブの active クラスを削除
            document.querySelectorAll('.monitor-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // 全統計表示を非表示
            document.querySelectorAll('.stats-display').forEach(stats => {
                stats.style.display = 'none';
            });

            // 選択されたモニターを表示
            document.getElementById(monitorId).classList.add('active');
            event.target.classList.add('active');

            // 対応する統計を表示
            const statsId = 'stats-' + monitorId;
            const statsElement = document.getElementById(statsId);
            if (statsElement) {
                statsElement.style.display = 'block';
            }

            currentMonitor = monitorId;

            // モニター切り替え時に表示を更新
            updateAllViews();
        }

        // === 全ビュー更新 ===
        // === 経験値追加 ===
        function addExperience(exp) {
            userExp += exp;
            
            // レベルアップチェック
            while (userExp >= EXP_TO_LEVEL_UP) {
                userExp -= EXP_TO_LEVEL_UP;
                userLevel++;
                showStatus(`🎉 レベルアップ！ LV.${userLevel}になりました！`, 'success');
            }
            
            updateExpDisplay();
        }

        // === 12時計AI分類関数 ===
        async function classifyWithAI(recordText) {
            try {
                const prompt = `医学生の実習記録を2つの独立した方法で分析してください。

記録: "${recordText}"

【タスク1: 12時計分類】
以下の13カテゴリから最も適切なものを1つ選んでください：

0時: 分類不能（医学実習との関連が不明確、意図が読み取れない）
1時: 地域医療（訪問診療、在宅医療、地域特性）
2時: 医療倫理（倫理、法律、規範）
3時: 医学知識（疾患、症候、基礎医学）
4時: 診察・手技（診察スキル、検査手技）
5時: 患者に対する問題解決能力（個別対応、治療方針決定）
6時: 統合的臨床（臨床能力の統合）
7時: 多職種連携（チーム医療、院内連携）
8時: コミュニケーション（対人能力）
9時: 一般教養（医学以外の知識）
10時: 施設連携（病院間連携、紹介）
11時: 保健・福祉（介護、保健事業）
12時: 統合的社会（社会医学の統合）

※「空が青かった」のような記録で医学実習との関連が不明な場合は0時を選択

【タスク2: 深度とベクトル座標】
以下を独立して判定してください：

深度（0-4）:
0: 知らない
1: 知っている（名称レベル）
2: 理解している（背景・因果関係）
3: 説明できる（再現性は低い）
4: 定着している（統合的レベル）

座標:
x軸（-1.0〜1.0）: -1=non-technical skill ← → +1=technical skill
y軸（-1.0〜1.0）: -1=臨床（ベッドサイド） ← → +1=地域・社会

回答形式:
{
  "clock_category": 数値(0-12),
  "clock_reason": "分類理由",
  "depth": 数値(0-4),
  "depth_reason": "深度判定理由",
  "vector": {
    "x": 数値(-1.0〜1.0),
    "y": 数値(-1.0〜1.0)
  },
  "vector_reason": "座標判定理由"
}`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.3,
                        response_format: { type: "json_object" }
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const result = JSON.parse(data.choices[0].message.content);
                
                // 整合性チェック
                let consistency_score = 100;
                if (result.clock_category === 0) {
                    // 分類不能の場合は整合性チェックをスキップ
                    consistency_score = 0; // 整合性は評価不能
                } else {
                    const expectedVector = CLOCK_CATEGORIES[result.clock_category].vector;
                    const deviation = {
                        x: Math.abs(expectedVector.x - result.vector.x),
                        y: Math.abs(expectedVector.y - result.vector.y)
                    };
                    consistency_score = 100 - (deviation.x + deviation.y) * 50;
                }
                
                return {
                    category: result.clock_category,
                    confidence: Math.max(50, consistency_score),
                    reason: result.clock_reason,
                    depth: result.depth,
                    vector: result.vector,
                    consistency: consistency_score > 70
                };
            } catch (error) {
                console.error('AI分類エラー:', error);
                // フォールバック
                return {
                    category: 7,
                    confidence: 50,
                    reason: 'AI分類に失敗しました',
                    depth: 1,
                    vector: {x: 0, y: 0},
                    consistency: false
                };
            }
        }
        
        // === 経験値表示更新 ===
        function updateExpDisplay() {
            // 記録回数更新
            const recordCount = records.filter(r => r.day === currentDay).length;
            document.getElementById('recordCount').textContent = recordCount;
            document.getElementById('recordCount2').textContent = recordCount;
            
            // レベル更新
            document.getElementById('userLevel').textContent = userLevel;
            document.getElementById('userLevel2').textContent = userLevel;
            
            // 経験値バー更新（隠しパラメータとして動作）
            const expPercent = (userExp / EXP_TO_LEVEL_UP) * 100;
            document.getElementById('expBar').style.width = expPercent + '%';
            document.getElementById('expBar2').style.width = expPercent + '%';
        }

        function updateAllViews() {
            updateRecordsList();
            updateOrganizedView();
            updateStatistics();
            updateExpDisplay();
        }

        // === 現在の日付の記録を取得 ===
        function getCurrentDayRecords() {
            return records.filter(record => record.day === currentDay);
        }

        // === 記録リスト更新（モニター1） ===
        function updateRecordsList() {
            const recordsList = document.getElementById('recordsList');
            const dayRecords = getCurrentDayRecords();
            
            if (dayRecords.length === 0) {
                recordsList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📝</div>
                        <p>まだ記録がありません<br>下のフォームから最初の記録を追加してください</p>
                    </div>
                `;
                return;
            }

            const html = dayRecords.map(record => {
                const category = AI_CATEGORIES[record.category] || AI_CATEGORIES.other;
                const timeStr = record.timestamp.toLocaleString('ja-JP', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                return `
                    <div class="record-item" data-id="${record.id}">
                        <div class="record-header">
                            <div class="record-timestamp">${timeStr}</div>
                            <div class="record-actions">
                                <button class="record-btn edit-btn" onclick="editRecord(${record.id})" title="編集">
                                    ✒️
                                </button>
                                <button class="record-btn delete-btn" onclick="deleteRecord(${record.id})" title="削除">
                                    🗑️
                                </button>
                            </div>
                        </div>
                        <div class="record-text">${record.originalText}</div>
                        <div>
                            <span class="record-category">${category.name}</span>
                            ${record.aiProcessed ? '<span class="record-ai-indicator">🤖</span>' : ''}
                            <span style="margin-left: 6px; color: #666; font-size: 0.75rem;">
                                ${record.confidence}%
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            recordsList.innerHTML = html;
        }

        // === 整理ビュー更新（モニター2） ===
        function updateOrganizedView() {
            const organizedView = document.getElementById('organizedView');
            const dayRecords = getCurrentDayRecords();
            
            if (dayRecords.length === 0) {
                organizedView.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">🤖</div>
                        <p>記録を追加すると<br>AI分析による12時計分類が表示されます</p>
                    </div>
                `;
                return;
            }

            // カテゴリ別にグループ化
            const groupedRecords = {};
            dayRecords.forEach(record => {
                const category = record.category || 'other';
                if (!groupedRecords[category]) {
                    groupedRecords[category] = [];
                }
                groupedRecords[category].push(record);
            });

            // HTML生成
            let html = '';
            for (const [categoryId, categoryRecords] of Object.entries(groupedRecords)) {
                const category = AI_CATEGORIES[categoryId] || AI_CATEGORIES[7]; // デフォルトは自己省察
                
                html += `
                    <div class="category-section">
                        <div class="category-header">
                            ${category.name} (${categoryRecords.length}件)
                        </div>
                        <div class="category-content">
                            ${categoryRecords.map(record => `
                                <div class="category-item">
                                    <div class="category-text">${record.originalText}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            organizedView.innerHTML = html;
        }

        // === 統計更新 ===
        function updateStatistics() {
            // 基本統計
            document.getElementById('totalRecords').textContent = records.length;
            
            // 今日の記録数
            const today = new Date().toDateString();
            const todayCount = records.filter(r => r.timestamp.toDateString() === today).length;
            document.getElementById('todayRecords').textContent = todayCount;
            
            // AI処理済み数
            const aiCount = records.filter(r => r.aiProcessed).length;
            document.getElementById('aiProcessed').textContent = aiCount;

            // カテゴリ数
            const uniqueCategories = new Set(records.map(r => r.category)).size;
            document.getElementById('categoryCount').textContent = uniqueCategories;

            // 平均信頼度
            if (records.length > 0) {
                const avgConfidence = Math.round(
                    records.reduce((sum, r) => sum + r.confidence, 0) / records.length
                );
                document.getElementById('avgConfidence').textContent = avgConfidence + '%';
            }
        }

        // === 記録編集 ===
        function editRecord(recordId) {
            const record = records.find(r => r.id === recordId);
            if (!record) return;

            const recordElement = document.querySelector(`[data-id="${recordId}"]`);
            const textElement = recordElement.querySelector('.record-text');
            
            // 編集モードに切り替え
            recordElement.classList.add('edit-mode');
            textElement.innerHTML = `
                <textarea class="edit-textarea">${record.originalText}</textarea>
                <div class="edit-actions">
                    <button class="record-btn save-btn" onclick="saveRecord(${recordId})" title="保存">✓</button>
                    <button class="record-btn cancel-btn" onclick="cancelEdit(${recordId})" title="キャンセル">×</button>
                </div>
            `;
        }

        // === 記録保存 ===
        function saveRecord(recordId) {
            const record = records.find(r => r.id === recordId);
            if (!record) return;

            const recordElement = document.querySelector(`[data-id="${recordId}"]`);
            const textarea = recordElement.querySelector('.edit-textarea');
            const newText = textarea.value.trim();

            if (newText) {
                record.originalText = newText;
                updateAllViews();
                showStatus('✅ 記録を更新しました。', 'success');
            }
        }

        // === 編集キャンセル ===
        function cancelEdit(recordId) {
            updateAllViews();
        }

        // === 記録削除 ===
        function deleteRecord(recordId) {
            if (confirm('この記録を削除しますか？')) {
                records = records.filter(r => r.id !== recordId);
                updateAllViews();
                showStatus('🗑️ 記録を削除しました。', 'warning');
            }
        }

        // === 日次レポート生成 ===
        function generateDailyReport() {
            const dailyReport = document.getElementById('dailyReport');
            const dayRecords = getCurrentDayRecords();
            
            if (dayRecords.length === 0) {
                showStatus(`${currentDay === 'practice' ? '練習用' : `${currentDay}日目`}の記録がありません。`, 'warning');
                return;
            }

            // カテゴリ別に分類
            const categoryGroups = {};
            dayRecords.forEach(record => {
                const category = record.category || 'other';
                if (!categoryGroups[category]) {
                    categoryGroups[category] = [];
                }
                categoryGroups[category].push(record);
            });

            // レポート生成
            let reportHtml = `
                <div class="report-content">
                    <h4>📋 ${currentDay === 'practice' ? '練習用' : `${currentDay}日目`}の実習レポート</h4>
                    
                    <div class="report-section">
                        <h4>📊 概要</h4>
                        <p>${currentDay === 'practice' ? '練習' : `${currentDay}日目`}は${dayRecords.length}件の学習記録を作成しました。</p>
                        <p>記録されたカテゴリ: ${Object.keys(categoryGroups).length}項目</p>
                    </div>
            `;

            // カテゴリ別詳細
            for (const [categoryId, categoryRecords] of Object.entries(categoryGroups)) {
                const category = AI_CATEGORIES[categoryId] || AI_CATEGORIES[7]; // デフォルトは自己省察
                
                reportHtml += `
                    <div class="report-section">
                        <h4>${category.name}</h4>
                        <ul>
                            ${categoryRecords.map(record => `
                                <li>${record.originalText}</li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            reportHtml += `
                    <div class="report-section">
                        <h4>💡 まとめ</h4>
                        <p>今日の実習では様々な学びがありました。特に${Object.keys(categoryGroups)[0] ? AI_CATEGORIES[Object.keys(categoryGroups)[0]].name : '実習体験'}に関する理解が深まりました。</p>
                    </div>
                </div>
            `;

            dailyReport.innerHTML = reportHtml;
            showStatus('📊 本日のレポートを生成しました！', 'success');
        }

        // === 次の日へ進む ===
        // === 前の日へ機能 ===
        function previousDay() {
            const currentDayElement = document.getElementById('currentDay');
            if (currentDayElement) {
                const currentDay = parseInt(currentDayElement.textContent) || 1;
                if (currentDay > 1) {
                    currentDayElement.textContent = currentDay - 1;
                    showStatus(`Day ${currentDay - 1}に戻りました`, 'success');
                    // 表示を更新
                    updateAllViews();
                } else {
                    showStatus('これ以上前の日には戻れません', 'error');
                }
            }
        }

        async function advanceDay() {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentName) {
                showStatus('学生名を入力してください。', 'error');
                return;
            }

            try {
                // ローカルで日数を進める
                const currentDayElement = document.getElementById('currentDay');
                const currentDayText = currentDayElement.textContent;
                const currentDayNum = parseInt(currentDayText.replace('日目', '')) || 1;
                const nextDay = Math.min(currentDayNum + 1, 5);
                
                currentDayElement.textContent = nextDay + '日目';
                showStatus(`✅ ${nextDay}日目に進みました！`, 'success');

                // GAS連携（バックグラウンド）
                try {
                    const response = await fetch(window.location.href, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'advanceDay',
                            studentName: studentName
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log('日次進行結果:', result);
                    }
                } catch (gasError) {
                    console.log('GAS日次進行スキップ:', gasError);
                }

            } catch (error) {
                console.error('日次進行エラー:', error);
                showStatus('❌ 日次進行に失敗しました。', 'error');
            }
        }


        // === ステータス表示 ===
        function showStatus(message, type = 'info') {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            
            // 5秒後に消去
            setTimeout(() => {
                statusMessage.innerHTML = '';
            }, 5000);
        }

        // === ドロップダウン開閉 ===
        function toggleDayDropdown() {
            const dropdown = document.getElementById('dayDropdown');
            dropdown.classList.toggle('active');
        }

        // === 日付選択機能 ===
        function selectDay(day) {
            currentDay = day;
            
            // ドロップダウンのアクティブ状態を更新
            document.querySelectorAll('.day-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // ラベルを更新
            const dayLabel = document.getElementById('currentDayLabel');
            dayLabel.textContent = day === 'practice' ? '練習用' : `${day}日目`;
            
            
            // ドロップダウンを閉じる
            document.getElementById('dayDropdown').classList.remove('active');
            
            // 表示を更新
            updateAllViews();
            
        }


        // === 初期化 ===
        document.addEventListener('DOMContentLoaded', function() {
            console.log('MULTAs システム初期化完了');
            
            // 初期表示設定
            document.getElementById('stats-monitor1').style.display = 'block';
            
            updateAllViews();
            
            // Enter キーでの送信
            document.getElementById('experienceText').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    submitExperience();
                }
            });

            // テキストエリアの動的リサイズ
            const textarea = document.getElementById('experienceText');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // ドロップダウンの外側クリックで閉じる
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.day-display')) {
                    document.getElementById('dayDropdown').classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>